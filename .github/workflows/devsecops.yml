name: DevSecOps Pipeline

on:
  workflow-dispatch

jobs:
  security-pipeline:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      # SAST
      - run: brakeman -o brakeman-report.json

      # DAST
      - run: docker-compose up -d
      - run: docker run -t owasp/zap2docker-stable zap-baseline.py -t http://localhost:3000 -r zap-report.html

      # SBOM
      - run: syft packages . -o spdx-json > sbom.json

      # SCA
      - run: trivy fs . --format json --output trivy-report.json

      # Secrets
      - uses: zricethezav/gitleaks-action@v2

      # Upload reports to DefectDojo
      - run: ./scripts/upload-to-defectdojo.sh
